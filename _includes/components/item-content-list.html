{%- comment -%}

  Consolidate markup for Content List Items.

{%- endcomment -%}
{%- assign link = page.bookmark_of.link | default: page.bookmark_of | default: page.like_of.link | default: page.like_of | default: page.listen_of.link | default: page.listen_of | default: page.read_of.link | default: page.read_of | default: page.watch_of.link | default: page.watch_of | default: page.link | default: null -%}
{%- assign category_link = site.data.categories | where: 'category', page.category | first | map: 'type' -%}
{%- assign date_human = page.date | date_to_long_string -%}
{%- if include.relative_year == true -%}
    {%- assign year_today = site.time | date: '%Y' -%}
    {%- assign year_then = page.date | date: '%Y' -%}
    {%- assign date_human = year_today | minus: year_then | append: ' years ago' -%}
{%- endif -%}
<li role="listitem">
    <article class="{% unless include.strip_h == true %}h-entry{% endunless %}" role="article">
        <a class="u-url" href="{{ page.url }}">
            <h3 class="delta  title{% unless page.titlefree %}  p-name{% endunless %}"{% if page.titlefree %} aria-hidden="true" hidden{% endif %}>
                {% if page.titlefree %}
                    {{ page.date | date: '%A, %d %B %Y' }}
                {% else %}
                    {{ page.title | strip_html }}
                {% endif %}
            </h3>
            <div class="lede">
                {% if page.in_reply_to.first %}
                    {%- assign mastodon_instance = null -%}
                    {%- assign mastodon_username = null -%}
                    {%- assign twitter_username = null -%}
                    {%- assign reply_target = null -%}
                    {%- for target in site.data.people -%}
                        {%- if target.mastodon -%}
                            {%- assign mastodon_instance = target.mastodon | split: '@' | last -%}
                            {%- assign mastodon_username = target.mastodon | split: '@' | first -%}
                            {%- if page.in_reply_to.first contains mastodon_instance and page.in_reply_to.first contains mastodon_username -%}
                                {%- assign reply_target = target | map: 'name' | default: null -%}
                                {%- break -%}
                            {%- endif -%}
                        {%- endif -%}
                    {%- endfor -%}
                    {%- unless reply_target -%}
                        {%- assign mastodon_instance = site.data.mastodon_instances | where_exp: 'target', 'page.in_reply_to.first contains target' | first | default: null -%}
                        {%- if mastodon_instance -%}
                            {%- if page.in_reply_to.first contains '/@' -%}
                                {%- assign mastodon_username = page.in_reply_to.first | split: '/@' | last | split: '/' | first | default: null -%}
                            {%- elsif page.in_reply_to.first contains '/users/' -%}
                                {%- assign mastodon_username = page.in_reply_to.first | split: '/users/' | last | split: '/' | first | default: null -%}
                            {%- endif -%}
                        {%- elsif page.in_reply_to.first contains 'twitter.com' -%}
                            {%- assign twitter_username = page.in_reply_to.first | split: '/status/' | first | split: 'twitter.com/' | last | default: null -%}
                            {%- assign reply_target = site.data.people | where_exp: 'target', 'target.twitter == twitter_username' | first | map: 'name' | default: null -%}
                        {%- else -%}
                            {%- assign reply_target = site.data.people | where_exp: 'target', 'page.in_reply_to.first contains target.link' | first | map: 'name' | default: null -%}
                        {%- endif -%}
                    {%- endunless -%}
                    {% if reply_target %}
                        {% assign reply = reply_target %}
                    {% elsif mastodon_instance %}
                        {% if mastodon_username %}
                            {% assign reply = '@' | append: mastodon_username | append: '@' | append: mastodon_instance %}
                        {% else %}
                            {% assign reply = 'a Toot' %}
                        {% endif %}
                    {% elsif page.in_reply_to.first contains 'twitter.com' %}
                        {% if twitter_username %}
                            {% assign reply = '@' | append: twitter_username %}
                        {% else %}
                            {% assign reply = 'a Tweet' %}
                        {% endif %}
                    {% else %}
                        {% assign reply = page.in_reply_to.first %}
                    {% endif %}
                    <span class="emoji">↩️</span> In reply to:
                    <data class="{% unless include.strip_h == true %}h-cite{% endunless %}  u-in-reply-to" value="{{ page.in_reply_to.first }}">{{ reply }}</data>
                    <br>
                {% endif %}
                {% if page.emoji %}
                    <span class="emoji">{{ page.emoji }}</span>
                {% endif %}
                {% if page.rsvp or page.tags contains 'rsvp' %}
                    <span class="emoji">📅</span>
                {% endif %}
                {% if page.banner or page.banner_mobile or page.photo or page.cover or page.content contains '<img' %}
                    {% unless page.mf_root == 'review' %}
                        <span class="emoji">🖼️</span>
                    {% endunless %}
                {% endif %}
                {% if page.reacji %}
                    <span class="emoji  p-summary  e-content">{{ page.reacji }}</span>
                {% elsif page.lede %}
                    <span class="p-summary">{{ page.lede | replace: "'", "’" | strip_html | truncatewords: 20 | replace: ',...', '...' | replace: '....', '...' | strip }}</span>
                    <span class="e-content" aria-hidden="true" hidden>{{ page.lede | replace: "'", "’" | strip_html | strip }}</span>
                {% elsif page.category == 'music' %}
                    <span class="p-summary  e-content">Album <span>Review</span></span>
                {% elsif page.category == 'note' %}
                    {%- assign content = page.content | markdownify | strip_html | replace: '&lt;figcaption&gt;', '' | replace: '&lt;/figcaption&gt;', '' | replace: '&lt;p&gt;', '' | replace: '&lt;/p&gt;', '' | strip -%}
                    <span class="p-summary">{{ content | truncatewords: 30 | replace: ',...', '...' | replace: '....', '...' | strip }}</span>
                    <span class="e-content" aria-hidden="true" hidden>{{ content }}</span>
                {% else %}
                    <span class="p-summary  e-content">{% include content/capitalizer.html input=page.category %}{% if page.layout == 'review' %} <span>Review</span>{% endif %}</span>
                {% endif %}
                {% if page.layout == 'review' and page.authors %}
                    by
                    {%- assign authors = page.authors | uniq -%}
                    {%- for author in authors -%}
                        {%- assign author_name = author.name | default: author | strip -%}
                        {%- assign author_map = site.data.people | where_exp: 'target', 'author_name == target.name' | first | default: null -%}
                        {% unless forloop.first %}, {% endunless %}
                        <span class="{% unless include.strip_h == true %}h-cite{% endunless %}">{{ author_name }}</span>
                    {%- endfor -%}
                {% endif %}
                {% if page.checkin %}
                    <data class="checkin">
                        <span class="emoji">🗺</span>
                        <span class="p-location">{{ page.checkin.name | default: page.checkin }}</span>
                    </data>
                {% endif %}
                {% if page.badges %}
                    <data class="badges" value="{{ page.badges.size }}"><span class="emoji">🏅</span> Earned {{ page.badges.size }} badge{% if page.badges.size > 1 %}s{% endif %}.</data>
                {% endif %}
                {% if page.rating and page.rating == 'Parti Pris' %}
                    <data value="Parti Pris" aria-hidden="true" hidden>Parti Pris</data>
                {% elsif page.rating %}
                    {%- assign rating_base = page.rating | default: 0 | at_least: 0 | at_most: 5 | floor -%}
                    {%- assign rating_fraction = page.rating | minus: rating_base -%}
                    <data class="p-worst" aria-hidden="true" hidden>0</data>
                    <data class="p-best" aria-hidden="true" hidden>5</data>
                    <data class="p-rating  rating  delta" value="{{ page.rating }}">{% for count in (1..rating_base) %}★{% endfor %}{% if rating_fraction == 0.25 %}¼{% elsif rating_fraction == 0.5 %}½{% elsif rating_fraction == 0.75 %}¾{% endif %}</data>
                {% endif %}
            </div>
            {% if page.rsvp.date %}
                <time class="date  date--range" datetime="{{ page.rsvp.date | date_to_xmlschema }}">{{ page.rsvp.date | date_to_long_string }}{% if page.rsvp.finish %} – {{ page.rsvp.finish | date_to_long_string }}{% endif %}</time>
                <time class="dt-published" datetime="{{ page.date | date_to_xmlschema }}" hidden>{{ date_human }}</time>
            {% else %}
                <time class="date  dt-published" datetime="{{ page.date | date_to_xmlschema }}">{{ date_human }}</time>
            {% endif %}
        </a>
        {% if page.mf_property and link %}
            <data class="u-{{ page.mf_property }}" aria-hidden="true" hidden>{{ link }}</data>
        {% endif %}
        <data class="u-category" value="/{{ category_link }}" aria-hidden="true" hidden>{{ page.category }}</data>
        <a class="u-author" href="/" aria-hidden="true" hidden tabindex="-1"></a>
    </article>
</li>
