<!-- Main Scripts -->
<script src="/js/main.min.js"></script>

{% if page.caniuse %}
    <!-- Can I Use Embeds -->
    <script src="https://cdn.jsdelivr.net/caniuse-embed/1.0.1/caniuse-embed.min.js" async defer></script>
{% endif %}

{% if page.codepen or page.codepen_slug %}
    <!-- CodePen Embeds -->
    <script src="https://codepen.io/assets/embed/ei.js" async defer></script>
{% endif %}

{% if page.speakerdeck or page.speakerdeck_slug %}
    <!-- Speaker Deck Embeds -->
    <script src="https://speakerdeck.com/assets/embed.js" async defer></script>
{% endif %}

{% if page.twitter or in_reply_to_link contains 'twitter.com' %}
    <!-- Twitter Cards -->
    <script src="https://platform.twitter.com/widgets.js" async defer></script>
{% endif %}

{%- assign in_reply_to_link_mastodon_instance = site.data.mastodon_instances | where_exp: 'instance', 'in_reply_to_link contains instance' | first | default: null -%}
{% if page.mastodon or in_reply_to_link_mastodon_instance %}
    <!-- Mastodon Cards -->
    <script src="https://{{ in_reply_to_link_mastodon_instance }}/embed.js" async defer></script>
{% endif %}

<!-- ServiceWorker -->
<script>
    const notification = document.querySelector(".notification");

    let updateNotification = (text, type = "positive") => {
        notification.innerHTML = text;
        notification.classList.add(`notification--${type}`);
        notification.classList.remove("hidden");
        setTimeout(() => {
            notification.classList.add("hidden");
            notification.classList.remove(`notification--${type}`);
        }, 1000);
    };

    let updateNetwork = (event) => {
        if (navigator.onLine) {
            console.log("You have regained your network connection.");
            notification.innerHTML = "👍 You have regained your network connection.";
            notification.classList.add("notification--positive");
        } else {
            console.log("You have lost your network connection.");
            notification.innerHTML = "👎 You have lost your network connection.";
            notification.classList.add("notification--negative");
        }
        notification.classList.remove("hidden");
        setTimeout(() => {
            notification.classList.add("hidden");
            notification.classList.remove("notification--positive", "notification--negative");
        }, 1000);
    };

    if ("serviceWorker" in navigator) {
        navigator.serviceWorker
            .register("/serviceworker.js")
            .then(registration => {
                console.log("ServiceWorker registration successful with scope:", registration.scope);
                let serviceWorker;
                if (registration.installing) {
                    serviceWorker = registration.installing;
                }
                else if (registration.waiting) {
                    serviceWorker = registration.waiting;
                }
                else if (registration.active) {
                    serviceWorker = registration.active;
                }
                if (serviceWorker) {
                    serviceWorker.addEventListener("statechange", () => {
                        if (registration.active && !navigator.serviceWorker.controller) {
                            updateNotification("🤩 All cached and ready to go offline!", "positive");
                        }
                    });
                }
            })
            .catch(err => {
                console.log("ServiceWorker registration failed:", err);
            });
        window.addEventListener("load", () => {
            window.addEventListener("online", updateNetwork);
            window.addEventListener("offline", updateNetwork);
            if (!!navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    command: "trimCaches"
                });
            }
        });
    } else {
        console.log("ServiceWorkers are not supported in your browser.");
    }
</script>
