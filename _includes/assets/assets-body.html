<!-- CSS rel="preload" Polyfill -->
<script>
{% include generated/css-rel-preload.html %}
</script>

<!-- Main Scripts -->
<script src="/js/main.min.js"></script>

{% if page.caniuse %}
    <!-- Can I Use Embeds -->
    <script src="//cdn.jsdelivr.net/caniuse-embed/1.0.1/caniuse-embed.min.js" defer></script>
{% endif %}

{% if page.codepen == true or page.codepen_slug %}
    <!-- CodePen Embeds -->
    <script src="//codepen.io/assets/embed/ei.js" defer></script>
{% endif %}

{% if page.speakerdeck == true or page.speakerdeck_slug %}
    <!-- Speaker Deck Embeds -->
    <script src="//speakerdeck.com/assets/embed.js" defer></script>
{% endif %}

{% if page.twitter == true %}
    <!-- Twitter Cards -->
    <script src="//platform.twitter.com/widgets.js" defer></script>
{% endif %}

<!-- ServiceWorker -->
<script>
    const bodyElement = document.querySelector("body");
    const networkElement = document.querySelector(".network");

    if ("serviceWorker" in navigator) {
        navigator.serviceWorker
            .register("/serviceworker.js")
            .then(registration => {
                console.log("ServiceWorker registration successful with scope:", registration.scope);
                let serviceWorker;
                if (registration.installing) {
                    serviceWorker = registration.installing;
                }
                else if (registration.waiting) {
                    serviceWorker = registration.waiting;
                }
                else if (registration.active) {
                    serviceWorker = registration.active;
                }
                if (serviceWorker) {
                    serviceWorker.addEventListener("statechange", () => {
                        if (registration.active && !navigator.serviceWorker.controller) {
                            bodyElement.classList.add("offline-ready");
                            networkElement.innerHTML = "All cached and ready to go offline!";
                        }
                    });
                }
            })
            .catch(err => {
                console.log("ServiceWorker registration failed:", err);
            });
        window.addEventListener("load", () => {
            function updateNetwork(event) {
                if (navigator.onLine) {
                    console.log("You have regained your network connection.");
                    networkElement.innerHTML = "You have regained your network connection.";
                    bodyElement.classList.remove("is-offline");
                    setTimeout(() => {
                        bodyElement.classList.add("is-online");
                    }, 5);
                } else {
                    console.log("You have lost your network connection.");
                    networkElement.innerHTML = "You have lost your network connection.";
                    bodyElement.classList.remove("is-online");
                    setTimeout(() => {
                        bodyElement.classList.add("is-offline");
                    }, 5);
                }
            }
            window.addEventListener("online", updateNetwork);
            window.addEventListener("offline", updateNetwork);
            if (!!navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ command: "trimCaches" });
            }
        });
    } else {
        console.log("ServiceWorkers are not supported in your browser.");
    }
</script>
